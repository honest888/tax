<!--头部css位置s-->
{include file='public:header-css'/}
<!--头部css位置e-->
<script src="__MOBILE__/js/swiper.min.js"></script>
<script src="__STATIC__/plugin/layer/layer.js"></script>
<script src="__STATIC__/plugin/layui/layui.js"></script>
<body>
<!--头部导航位置s-->
<header class="header trs">
    <a class="back iconfont iconback"></a>
    <div class="title">商品详情</div>
    <a id="popup" class="iconfont iconmenu"></a>
</header>
<!--头部导航位置e-->
<!--轮播位置s-->
<div class="swiper-container">
    <div class="swiper-wrapper">
        {volist name="$goods_images" id="image"}
        <div class="swiper-slide">
            <img src="{$image}">
        </div>
        {/volist}
    </div>
    <div class="swiper-pagination"></div>
</div>
<!--轮播位置e-->
<!--商品s-->
<div id="goodsInfo">
    <div class="title">
        <div class="good-name">{$goods.goods_name}</div>
        {if $goods.goods_remark}<div class="desc">{$goods.goods_remark}</div>{/if}
        <div class="price">
            <span>售价：￥{$goods.goods_price}</span>
            <span>销量：{$goods.sales_sum}件</span>
        </div>
    </div>
    <div class="content mto10 bg-fff">
        <div class="public_title">商品详情</div>
        <div class="info">
            {$goods.goods_content|raw}
        </div>
    </div>
</div>
<!--商品e-->
<!--规格弹窗s-->
<div id="goodsAlert">
    <div class="goodsShade"></div>
    <div class="goodsInnder">
        <div class="goodsAlertInfo">
            <div class="title"><span class="iconfont iconguanbi"></span></div>
            <div class="good">
                <div class="left">
                    <img id="goods_img" src="{$goods.goods_img}">
                </div>
                <div class="right">
                    <p>{$goods.goods_name}</p>
                    <p class="ccc"><span class="red goodprice">￥{$goods.goods_price}</span><span class="spec_name m4-left"></span></p>
                </div>
            </div>
            <div class="goodsnum">
                <div class="left">数量</div>
                <div class="right">
                    <div class="number-box">
                        <div class="reduce dis" onclick="cartnum(this,-1)">-</div>
                        <input type="number" data-max="{$goods.store_count}" id="goods_num" value="1">
                        <div class="add" onclick="cartnum(this,1)">+</div>
                    </div>
                </div>
            </div>
            {foreach name="$filter_spec" item="spec" key="k1"}
                <div class="item">
                    <div class="itemtitle">{$k1}</div>
                        <div class="iteminfo">
                            {foreach name="spec" item="vo" key="k2"}
                            <span class="spec {if $k2 == 0}act{/if}" data-src="{$vo.src}" data-id="{$vo.item_id}">{$vo.item}</span>
                            {/foreach}
                        </div>
                </div>
            {/foreach}
            <div style="height: 65px"></div>
        </div>
        <div class="goodsBtnList">
            <button type="button" id="cartbtn">加入购物车</button>
            <a href="javascript:;" id="submit">立即购买</a>
        </div>
    </div>
</div>
<!--规格弹窗e-->
<div class="public-bottom buy">
    <div class="public-bottom-item">
        <div class="left">
            <a href="{:url('Index/index')}">
                <span class="iconfont iconindex"></span>
                <span class="badge"></span>
                <p>首页</p>
            </a>
            <a onclick="collect(this)" {if $edit}class="red"{/if}>
                <span class="iconfont {if $edit}iconshoucang{else/}iconshoucang1{/if}"></span>
                <p class="text">{if $edit}已收藏{else/}收藏{/if}</p>
            </a>
        </div>
        <a class="right btn-two">
            <button id="buy" class="bg-red fff">
            立即购买
            </button>
        </a>
    </div>
</div>
<form action="{:url('Cart/cart')}" method="post" id="form">
    <input type="hidden" name="goods_id" value="{$goods.goods_id}">
    <input type="hidden" name="item_id" value="">
    <input type="hidden" name="goods_num" value="1">
    <input type="hidden" name="action" value="buy_now">
</form>
</body>
<style>
    .swiper-container {
        height: 360px;
    }
</style>
<script>
    var items=$.parseJSON('{$spec_goods_price|raw}');
    function goodsClose(){
        var h=$('.goodsInnder').outerHeight();
        $('.goodsInnder').stop().animate({'bottom':-(h+30)},500,function () {
            $('#goodsAlert').hide();
        });
    }
    function initSpec(obj=''){
        var spec=$('.spec');
        if (items==''){
            $('.spec_name').hide();
            return;
        }
        var sel=[];
        spec.each(function () {
            if ($(this).hasClass('act')){
                sel.push($(this).data('id'))
            }
        });
        sel=sel.sort(sortNumber).join('_');
        var item=items[sel];
        var img=$(obj).data('src');
        var spec_name=item['key_name'];
        var item_id=item['item_id'];
        var add_fee=item['add_fee'];
        var store_count=item['store_count'];
        var price=item['price'];
        if (img){
            $('#goods_img').attr('src',img);
        }
        $('[name=item_id]').val(item_id);
        $('.spec_name').text(spec_name);
        $('.goodprice').text('￥'+price);
        $('#goods_num').attr('data-max',store_count);
    }
    function sortNumber(a,b)
    {
        return a - b
    }
    $(function () {
        initSpec();
        cartnum('',0);
        $('.iconguanbi,.goodsShade').click(function () {
            goodsClose();
        });
        $('.spec').click(function () {
            if ($(this).hasClass('act')) return;
            $(this).addClass('act').siblings().removeClass('act');
            initSpec(this);
        });
        $('#buy').click(function () {
            $('#goodsAlert').show();
            $('.goodsInnder').stop().animate({'bottom':0},500);
        });
        $('#submit').click(function () {
            var form=$('#form');
            form.submit();
        });
        $('#goods_num').blur(function () {
            var val=$(this).val();
            var re = /^[0-9]+$/ ;
            if (re.test(val)==false){
                $(this).val(1);
            }
            cartnum('',0);
        });
        $('#cartbtn').click(function () {
            var goods_num=parseInt($('[name=goods_num]').val());
            var goods_id=$('[name=goods_id]').val();
            var item_id=$('[name=item_id]').val() | 0;
            if (goods_num<=0){
                msg('购买数量有误');
                return false;
            }
            $.ajax({
                url:"{:url('Cart/cart_add')}",
                type:'post',
                data:{goods_num:goods_num,goods_id:goods_id,item_id:item_id},
                dataType:'json',
                success:function (res) {
                    if (res.code==1){
                        msg(res.msg);
                        goodsClose();
                    }else if (res.code==-100) {
                        msg(res.msg,res.url);
                    }else {
                        msg(res.msg);
                    }
                },error:function () {
                    msg('网络错误,请稍后再试!')
                }
            });
        });
    });
    function collect(obj) {
        var goods_id=$('[name=goods_id]').val();
        var icon=$(obj).find('.iconfont');
        var type=0;
        var text='';
        if (icon.hasClass('iconshoucang1')){
            text='已收藏';
            type=1;
        } else {
            text='收藏';
            type=-1;
        }
        $.ajax({
            url:"{:url('Goods/collect_goods')}",
            type:'post',
            data:{type:type,goods_id:goods_id},
            dataType:'json',
            success:function (res) {
                if (res.code==1){
                    msg(res.msg);
                    if (type==1){
                        $(obj).addClass('red');
                        $(obj).find('.text').text(text);
                        icon.addClass('iconshoucang').removeClass('iconshoucang1');
                    }else {
                        $(obj).removeClass('red');
                        $(obj).find('.text').text(text);
                        icon.addClass('iconshoucang1').removeClass('iconshoucang');
                    }
                }else if (res.code==-100) {
                    msg(res.msg,res.url);
                }else {
                    msg(res.msg);
                }
            },error:function () {
                msg('网络错误,请稍后再试!')
            }
        });
    }
    function cartnum(obj='',number) {
        var num=parseInt($('#goods_num').val());
        var max=$('#goods_num').attr('data-max');
        if ($(obj).hasClass('dis')){
            return false;
        }
        num+=number;
        if (num<=1){
            num=1;
        }else if (num<max){
            num=num;
        }else if (num>=max){
            num=max;
        }
        if (max==1){
            $('.reduce').addClass('dis');
            $('.add').addClass('dis');
        }else if (num==1){
            $('.reduce').addClass('dis').siblings('.add').removeClass('dis');
        }else if (num>1 && num<max){
            $('.reduce').removeClass('dis');
            $('.add').removeClass('dis');
        }else if (num>=max){
            $('.add').addClass('dis').siblings('.reduce').removeClass('dis');
        }
        $('[name=goods_num]').val(num);
        $('#goods_num').val(num);
    }
    var swiper = new Swiper('.swiper-container', {
        loop:true,
        pagination: {
            el: '.swiper-pagination',
            dynamicBullets: true,
        },
        autoplay: {
            delay: 3000,
            stopOnLastSlide: false,
            disableOnInteraction: false,
        },
        effect:'coverflow',
    });
</script>
</html>